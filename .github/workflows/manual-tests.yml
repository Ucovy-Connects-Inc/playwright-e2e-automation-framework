name: ğŸ­ Run Tests for Management

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Which environment to test?'
        required: true
        default: 'qa'
        type: choice
        options:
        - qa
        - dev  
        - prod
      browser:
        description: 'Which browser to test?'
        required: true
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all

jobs:
  run-tests:
    name: ğŸ§ª Execute Tests & Generate Reports
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“‹ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright Browsers
        run: |
          if [ "${{ github.event.inputs.browser }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install --with-deps ${{ github.event.inputs.browser }}
          fi
        
      - name: âš™ï¸ Configure Environment
        run: |
          echo "ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "HEADLESS=true" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          echo "RETRIES=1" >> $GITHUB_ENV
          echo "WORKERS=2" >> $GITHUB_ENV
          
      - name: ğŸ”‘ Setup CAPTCHA Bypass
        run: |
          if [ -n "${{ secrets.AUTOMATION_SECRET }}" ]; then
            echo "âœ… CAPTCHA bypass enabled"
            echo "AUTOMATION_SECRET=${{ secrets.AUTOMATION_SECRET }}" >> $GITHUB_ENV
          else
            echo "âš ï¸ CAPTCHA bypass disabled - tests may fail on CAPTCHA steps"
          fi
          
      - name: ğŸ§ª Run Tests
        run: |
          echo "ğŸš€ Running tests on ${{ github.event.inputs.environment }} environment with ${{ github.event.inputs.browser }}"
          if [ "${{ github.event.inputs.browser }}" = "all" ]; then
            npx playwright test --reporter=list,allure-playwright,html
          else
            npx playwright test --project=${{ github.event.inputs.browser }} --reporter=list,allure-playwright,html
          fi
        env:
          ENV: ${{ github.event.inputs.environment }}
          AUTOMATION_SECRET: ${{ secrets.AUTOMATION_SECRET }}
          
      - name: ï¿½ Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
          
      - name: ğŸ“‹ Create Management Summary
        if: always()
        run: |
          echo "# ğŸ“Š Test Execution Summary for Management" > EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "**Date:** $(date)" >> EXECUTIVE_SUMMARY.md
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> EXECUTIVE_SUMMARY.md
          echo "**Browser:** ${{ github.event.inputs.browser }}" >> EXECUTIVE_SUMMARY.md
          echo "**Triggered by:** ${{ github.actor }}" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## ğŸ“ˆ How to View Results" >> EXECUTIVE_SUMMARY.md
          echo "1. Download this artifact" >> EXECUTIVE_SUMMARY.md
          echo "2. Extract the zip file" >> EXECUTIVE_SUMMARY.md
          echo "3. Open **allure-report/index.html** in your browser" >> EXECUTIVE_SUMMARY.md
          echo "4. View the beautiful dashboard with pass/fail percentages" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## ğŸ“Š What's Included" >> EXECUTIVE_SUMMARY.md
          echo "- ğŸ“ˆ **allure-report/** - Interactive dashboard with charts" >> EXECUTIVE_SUMMARY.md
          echo "- ğŸ“ **playwright-report/** - Detailed test results" >> EXECUTIVE_SUMMARY.md
          echo "- ğŸ› **test-results/** - Screenshots and videos of failures" >> EXECUTIVE_SUMMARY.md
          
      - name: ğŸ“¤ Upload Management Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“Š-MANAGEMENT-REPORT-${{ github.event.inputs.environment }}-${{ github.event.inputs.browser }}
          path: |
            allure-report/
            playwright-report/
            test-results/
            EXECUTIVE_SUMMARY.md
          retention-days: 30
          
      - name: ğŸŒ Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: latest-test-report