name: ðŸŽ­ Run Tests for Management

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Which environment to test?'
        required: true
        default: 'qa'
        type: choice
        options:
        - qa
        - dev  
        - prod
      browser:
        description: 'Which browser to test?'
        required: true
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all

jobs:
  run-tests:
    name: ðŸ§ª Execute Tests & Generate Reports
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ“‹ Install Dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "ðŸ“¦ Using npm ci (package-lock.json found)"
            npm ci
          else
            echo "ï¿½ Using npm install (no package-lock.json)"
            npm install
          fi
        
      - name: ðŸŽ­ Install Playwright Browsers
        run: |
          if [ "${{ github.event.inputs.browser }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install --with-deps ${{ github.event.inputs.browser }}
          fi
        
      - name: âš™ï¸ Configure Environment
        run: |
          # Create .env file for CI
          cat > .env << EOF
          ENV=${{ github.event.inputs.environment }}
          QA_BASE_URL=https://my.qa.marathon.health
          DEV_BASE_URL=https://stage.my.marathon-health.com
          PROD_BASE_URL=https://my.marathon-health.com
          HEADLESS=true
          CI=true
          RETRIES=1
          WORKERS=2
          EOF
          
          # Also set as environment variables
          echo "ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "QA_BASE_URL=https://my.qa.marathon.health" >> $GITHUB_ENV
          echo "DEV_BASE_URL=https://stage.my.marathon-health.com" >> $GITHUB_ENV
          echo "PROD_BASE_URL=https://my.marathon-health.com" >> $GITHUB_ENV
          
      - name: ðŸ” Debug Environment Variables
        run: |
          echo "ðŸ” Debugging environment configuration..."
          echo "ENV: ${{ github.event.inputs.environment }}"
          echo "Contents of .env file:"
          cat .env
          echo "Environment variables:"
          printenv | grep -E "(ENV|BASE_URL)"
          
      - name: ðŸ”‘ Setup CAPTCHA Bypass
        run: |
          echo "âš ï¸ CAPTCHA bypass disabled - configure AUTOMATION_SECRET in repository secrets if needed"
          
      - name: ðŸ§ª Run Tests
        run: |
          echo "ðŸš€ Running tests on ${{ github.event.inputs.environment }} environment with ${{ github.event.inputs.browser }}"
          if [ "${{ github.event.inputs.browser }}" = "all" ]; then
            npx playwright test --reporter=list,allure-playwright,html
          else
            npx playwright test --project=${{ github.event.inputs.browser }} --reporter=list,allure-playwright,html
          fi
        env:
          ENV: ${{ github.event.inputs.environment }}
          
      - name: ï¿½ Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
          
      - name: ðŸ“‹ Create Management Summary
        if: always()
        run: |
          echo "# ðŸ“Š Test Execution Summary for Management" > EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "**Date:** $(date)" >> EXECUTIVE_SUMMARY.md
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> EXECUTIVE_SUMMARY.md
          echo "**Browser:** ${{ github.event.inputs.browser }}" >> EXECUTIVE_SUMMARY.md
          echo "**Triggered by:** ${{ github.actor }}" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## ðŸ“ˆ How to View Results" >> EXECUTIVE_SUMMARY.md
          echo "1. Download this artifact" >> EXECUTIVE_SUMMARY.md
          echo "2. Extract the zip file" >> EXECUTIVE_SUMMARY.md
          echo "3. Open **allure-report/index.html** in your browser" >> EXECUTIVE_SUMMARY.md
          echo "4. View the beautiful dashboard with pass/fail percentages" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## ðŸ“Š What's Included" >> EXECUTIVE_SUMMARY.md
          echo "- ðŸ“ˆ **allure-report/** - Interactive dashboard with charts" >> EXECUTIVE_SUMMARY.md
          echo "- ðŸ“ **playwright-report/** - Detailed test results" >> EXECUTIVE_SUMMARY.md
          echo "- ðŸ› **test-results/** - Screenshots and videos of failures" >> EXECUTIVE_SUMMARY.md
          
      - name: ðŸ“¤ Upload Management Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸ“Š-MANAGEMENT-REPORT-${{ github.event.inputs.environment }}-${{ github.event.inputs.browser }}
          path: |
            allure-report/
            playwright-report/
            test-results/
            EXECUTIVE_SUMMARY.md
          retention-days: 30